<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Technology</title>
    <!-- FSharp.Formatting Styles -->
    <link rel="stylesheet" type="text/css" media="screen" href="http://tech.jet.com/fsharp.formatting/tooltips.css" />
    <script type="text/javascript" src="http://tech.jet.com/javascripts/video.fix.js"></script>
    <script type="text/javascript" src="http://tech.jet.com/javascripts/ga.js"></script>
    <script type="text/javascript" src="http://tech.jet.com/fsharp.formatting/tooltips.js"></script>
    <script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <link rel="stylesheet" href="http://tech.jet.com/stylesheets/styles.css">
    <link rel="stylesheet" href="http://tech.jet.com/stylesheets/pygment_trac.css">
    <link rel="shortcut icon" href="http://tech.jet.com/images/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script type="text/javascript">var switchTo5x=true;</script>
    <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js"></script>
    <script type="text/javascript">stLight.options({publisher: "81ce46a6-ba61-410c-bb73-5204cc8efed1", doNotHash: true, doNotCopy: false, hashAddressBar: false});</script></head>
<body>
    <header>
        <div>
            <a href="http://tech.jet.com/index.html" style="vertical-align:middle;"><img src="http://tech.jet.com/images/jet_logo.png" style="max-height:50px;" /></a><span class="subtitle">Technology</span>
            <div class="social">
                <ul>
                    <li>
                        <a class="social-icons" href="https://twitter.com/jettechnology"></a>
                    </li>
                    <li>
                        <a class="social-icons" href="https://twitter.com/jet"></a>
                    </li>
                    <li>
                        <a class="social-icons" href="https://www.facebook.com/jet"></a>
                    </li>
                    <li>
                        <a class="social-icons" href="https://www.github.com/jet"></a>
                    </li>
                    <li>
                        <a class="social-icons" href="https://linkedin.com/company/jet-com"></a>
                    </li>
                    <li>
                        <a class="social-icons" href="https://plus.google.com/118328800025960082059/posts"></a>
                    </li>
                </ul>
            </div>
        </div>
    </header>
    <leftpanel class="smaller">
        <h2><a href="https://jet.com/about-us/join-our-crew">Join us!</a></h2>

        <a class="twitter-timeline" data-dnt="true" href="https://twitter.com/JetTechnology" data-widget-id="652521231367995392">Tweets by @JetTechnology</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
        <br/><br/>

<!--       <h2>Tags</h2>
            <a href="http://tech.jet.com/blog/tag/fsharp/index.html">f#</a>
            <a href="http://tech.jet.com/blog/tag/community/index.html">community</a>
            <a href="http://tech.jet.com/blog/tag/microservices/index.html">microservices</a>
            <a href="http://tech.jet.com/blog/tag/jetdotcom/index.html">jet.com</a>
            <a href="http://tech.jet.com/blog/tag/jet-technology/index.html">jet technology</a>
            <a href="http://tech.jet.com/blog/tag/jetdotcom-technology/index.html">jet.com technology</a>
            <a href="http://tech.jet.com/blog/tag/azure/index.html">azure</a>
            <a href="http://tech.jet.com/blog/tag/cloud/index.html">cloud</a>
            <a href="http://tech.jet.com/blog/tag/continuous-learning/index.html">continuous learning</a>
            <a href="http://tech.jet.com/blog/tag/cloud-services/index.html">cloud services</a>
            <a href="http://tech.jet.com/blog/tag/micro-services/index.html">micro services</a>
            <a href="http://tech.jet.com/blog/tag/interview/index.html">interview</a>
            <a href="http://tech.jet.com/blog/tag/chaos-engineering/index.html">chaos engineering</a>
            <a href="http://tech.jet.com/blog/tag/performance-engineering/index.html">performance engineering</a>
            <a href="http://tech.jet.com/blog/tag/teaching/index.html">teaching</a>
            <a href="http://tech.jet.com/blog/tag/javascript/index.html">javascript</a>
            <a href="http://tech.jet.com/blog/tag/web-design/index.html">web design</a>
            <a href="http://tech.jet.com/blog/tag/technology/index.html">technology</a>
            <a href="http://tech.jet.com/blog/tag/marketing-tech/index.html">marketing tech</a>
        <br />-->
        <h2>Videos we <3</h2>
        <p>
            <ul>
                    <li><a href="http://tech.jet.com/videos/2015/12-16-why-your-team-has-slowed-down-why-that-s-worse-than-you-think-and-how-to-fix-it/index.html">Why Your Team Has Slowed Down, Why That's Worse than You Think, and How to Fix it</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/12-16-type-driven-development-mark-seemann-on-vimeo/index.html">Type-Driven Development - Mark Seemann on Vimeo</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/12-03-real-time-democratizing-of-event-driven-big-data-on-vimeo/index.html">REAL-TIME DEMOCRATIZING OF EVENT-DRIVEN BIG DATA on Vimeo</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/12-03-patterns-and-practices-for-real-world-event-driven-microservices-on-vimeo/index.html">PATTERNS AND PRACTICES FOR REAL-WORLD EVENT-DRIVEN MICROSERVICES on Vimeo</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/12-03-lambda-days-2015-evelina-gabasova-understanding-cancer-behaviour-with-f-on-vimeo/index.html">Lambda Days 2015 - Evelina Gabasova - Understanding cancer behaviour with F# on Vimeo</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/10-09-the-many-faces-of-apache-kafka-how-is-kafka-used-in-practice/index.html">The Many Faces of Apache Kafka: How is Kafka Used in Practice</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/10-09-journey-to-the-intelligent-cloud-azurecon-2015-channel-9/index.html">Journey to the intelligent cloud | AzureCon 2015 | Channel 9</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/09-02-the-next-generation-of-neural-networks/index.html">The Next Generation of Neural Networks</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/08-19-domain-driven-design-f-and-types-skillscast-13th-march-2014/index.html">Domain Driven Design, F# and Types | SkillsCast | 13th March 2014</a></li>
                    <li><a href="http://tech.jet.com/videos/2015/08-18-jet-com-kumail-nanjiani-explains-how-the-new-shopping-club-works/index.html">Jet.com - Kumail Nanjiani Explains How The New Shopping Club Works</a></li>
            </ul>
<!--            <small><a href="http://tech.jet.com/videos/">See all</a></small> -->
        </p>
    </leftpanel>
    <section>
        
<h1>How Jet Build Microservices with F#</h1>
<small>
    Rachel Reese &nbsp; &nbsp;| &nbsp; &nbsp;
    2015-11-27T12:27:02
        &nbsp;&nbsp;| &nbsp;&nbsp;f#, microservices
</small>
<br />
<span class='st_reddit'></span>
<span class='st_facebook'></span>
<span class='st_twitter'></span>
<span class='st_linkedin'></span>
<span class='st_googleplus'></span>
<span class='st_tumblr'></span>
<span class='st_instapaper'></span>
<span class='st_email'></span>
<div class="postbody">
    
<p>Happy first day of F# Advent!</p>

<p>I've had a lot of questions lately about our microservices, and how we're using F# to build them. So, I wanted to take this opportunity to go a bit more in-depth on what they look like. Let's start in the most basic place:</p>

<h3>Definitions</h3>

<p>What do microservices even mean to us? We belong to the SRP camp:</p>

<h1>A microservice is an application of the single responsibility principle at the service level.</h1>

<p>This means that a microservice should have one -- and only one -- reason to exist. Not necessarily that there should be only one function within the service, just that the microservice should have only one job.</p>

<p>We also note, generally, that we should strive to create microservices that have an input and produce an output. This will eliminate many side effects, and considering up front the inputs, outputs, and transformations that the service will have, helps us to do so. While this isn't always possible (logging and sending emails happens in the real world, but when they do, they should be isolated to their own service), abiding by this rule goes far in eliminating unnecessary side effects.</p>

<h3>Benefits</h3>

<p>The benefits of microservices fall into three main categories:</p>

<ol>
<li><p><em>Easy scalability.</em> It's only a matter of scaling a single service as needed. Did we receive a large shipment to the warehouse today, putting the related services -- and people ;) -- under heavy load? We can scale out just those services without regard for the rest of the system.</p></li>
<li><p><em>Independent releasability.</em> While it is possible to release a single service at once, we organize ourselves into teams, and our microservices into groups within our teams. Because we're using F#, each group of microservices is usually within the same Visual Studio solution. When we talk about independent releasability, we usually mean that we'll promote an entire solution of related services -- often a group of 5-10 -- at the same time.</p></li>
<li><p><em>A more even distribution of complexity.</em> By this, I mean that it generally becomes much more simple to create and maintain your services, but that it tends to be more difficult to manage all your services. Recently, during Jet's <a href="http://techgroup.jet.com/blog/2015/07-14-tech-talk-weekly/index.html">Tech Talk Weekly</a> series, we watched <a href="https://www.youtube.com/watch?v=I56HzTKvZKc">Tammer Saleh giving his "Microservices Anti-Patterns" talk</a>. One of the anti-patterns he mentioned was doubling down on microservices as a pattern and creating an application from the ground up with microservices. He suggests instead starting with a monolithic application and breaking off services as it becomes obvious that they're needed. This isn't how we proceeded at Jet, so I won't speak to it as a piece of advice, but I will add that because of the additional layers of complexity added with needing to manage your services, it's crucial to at least have your management story thought through, if not fully determined, right up front before you start to break off those services.</p></li>
</ol>

<h3>Communication</h3>

<p>We use a couple different methods for our microservices to communicate: Kafka, EventStore, and Azure ServiceBus with Azure Queues. For my examples today, I'll show off EventStore. However, in some cases, where we were mis-using EventStore more as a message bus anyway, we have decided to start moving away from EventStore in favor of Kafka.</p>

<h3>Code!</h3>

<p>So without further adieu, I present some example code. In this example, I've created a microservice that price checks a product on a competing site, in this case, the "Nile" shopping site. ;-)</p>

<p>We won't get very far if we don't define our types up front. Let's start with a <code>Product</code> record type that contains information about the product we want to price check.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 3)" onmouseover="showTip(event, 'fs2', 3)" class="i">Product</span> <span class="o">=</span> {
        <span onmouseout="hideTip(event, 'fs3', 4)" onmouseover="showTip(event, 'fs3', 4)" class="i">Sku</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 5)" onmouseover="showTip(event, 'fs4', 5)" class="i">string</span>
        <span onmouseout="hideTip(event, 'fs5', 6)" onmouseover="showTip(event, 'fs5', 6)" class="i">ProductId</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 7)" onmouseover="showTip(event, 'fs6', 7)" class="i">int</span>
        <span onmouseout="hideTip(event, 'fs7', 8)" onmouseover="showTip(event, 'fs7', 8)" class="i">ProductDescription</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 9)" onmouseover="showTip(event, 'fs4', 9)" class="i">string</span>
        <span onmouseout="hideTip(event, 'fs8', 10)" onmouseover="showTip(event, 'fs8', 10)" class="i">CostPer</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs9', 11)" onmouseover="showTip(event, 'fs9', 11)" class="i">decimal</span>
        }</pre>
</td>
</tr>
</table>

<p>We also need some additional members on the <code>Product</code> so that it's easily serializable: <code>ToJson</code> and <code>FromJson</code>, which convert a <code>Product</code> record type to and from <code>JSON</code>, using one of our internal libraries. We also want to create a type for the failure case. For that case, we'll need just the product id that we were trying to price check, and the failure message.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs2', 12)" onmouseover="showTip(event, 'fs2', 12)" class="i">Product</span> <span class="k">with</span>
        <span class="k">static</span> <span class="k">member</span> <span onmouseout="hideTip(event, 'fs10', 13)" onmouseover="showTip(event, 'fs10', 13)" class="i">ToJson</span>(<span onmouseout="hideTip(event, 'fs11', 14)" onmouseover="showTip(event, 'fs11', 14)" class="i">x</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs2', 15)" onmouseover="showTip(event, 'fs2', 15)" class="i">Product</span>) <span class="o">=</span>
            <span class="i">jobj</span> [|
                <span class="s">&quot;</span><span class="s">sku</span><span class="s">&quot;</span> <span class="o">.</span><span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 16)" onmouseover="showTip(event, 'fs11', 16)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs3', 17)" onmouseover="showTip(event, 'fs3', 17)" class="i">Sku</span>
                <span class="s">&quot;</span><span class="s">productId</span><span class="s">&quot;</span> <span class="o">.</span><span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 18)" onmouseover="showTip(event, 'fs11', 18)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs5', 19)" onmouseover="showTip(event, 'fs5', 19)" class="i">ProductId</span>
                <span class="s">&quot;</span><span class="s">productDescription</span><span class="s">&quot;</span> <span class="o">.</span><span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 20)" onmouseover="showTip(event, 'fs11', 20)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs7', 21)" onmouseover="showTip(event, 'fs7', 21)" class="i">ProductDescription</span>
                <span class="s">&quot;</span><span class="s">costper</span><span class="s">&quot;</span> <span class="o">.</span><span class="o">=</span> <span onmouseout="hideTip(event, 'fs11', 22)" onmouseover="showTip(event, 'fs11', 22)" class="i">x</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs8', 23)" onmouseover="showTip(event, 'fs8', 23)" class="i">CostPer</span>
            |]

        <span class="k">static</span> <span class="k">member</span> <span onmouseout="hideTip(event, 'fs12', 24)" onmouseover="showTip(event, 'fs12', 24)" class="i">FromJson</span> (_<span class="o">:</span><span onmouseout="hideTip(event, 'fs2', 25)" onmouseover="showTip(event, 'fs2', 25)" class="i">Product</span>) <span class="o">=</span>
            <span class="i">parseObj</span> <span class="o">&lt;|</span> <span class="k">fun</span> <span onmouseout="hideTip(event, 'fs13', 26)" onmouseover="showTip(event, 'fs13', 26)" class="i">json</span> <span class="k">-&gt;</span> <span class="i">jsonParse</span> {
                <span class="k">let!</span> <span class="i">sku</span> <span class="o">=</span> <span class="i">jget</span> <span onmouseout="hideTip(event, 'fs13', 27)" onmouseover="showTip(event, 'fs13', 27)" class="i">json</span> <span class="s">&quot;</span><span class="s">sku</span><span class="s">&quot;</span>
                <span class="k">let!</span> <span class="i">productid</span> <span class="o">=</span> <span class="i">jget</span> <span onmouseout="hideTip(event, 'fs13', 28)" onmouseover="showTip(event, 'fs13', 28)" class="i">json</span> <span class="s">&quot;</span><span class="s">productId</span><span class="s">&quot;</span>
                <span class="k">let!</span> <span class="i">productdescription</span> <span class="o">=</span> <span class="i">jget</span> <span onmouseout="hideTip(event, 'fs13', 29)" onmouseover="showTip(event, 'fs13', 29)" class="i">json</span> <span class="s">&quot;</span><span class="s">productDescription</span><span class="s">&quot;</span>
                <span class="k">let!</span> <span class="i">costper</span> <span class="o">=</span> <span class="i">jget</span> <span onmouseout="hideTip(event, 'fs13', 30)" onmouseover="showTip(event, 'fs13', 30)" class="i">json</span> <span class="s">&quot;</span><span class="s">costper</span><span class="s">&quot;</span>
                <span class="k">return</span> {
                    <span onmouseout="hideTip(event, 'fs2', 31)" onmouseover="showTip(event, 'fs2', 31)" class="i">Product</span><span class="o">.</span><span class="i">Sku</span> <span class="o">=</span> <span class="i">sku</span>
                    <span class="i">ProductId</span> <span class="o">=</span> <span class="i">productid</span>
                    <span class="i">ProductDescription</span> <span class="o">=</span> <span class="i">productdescription</span>
                    <span class="i">CostPer</span> <span class="o">=</span> <span class="i">costper</span>
                }
            }
        <span class="k">static</span> <span class="k">member</span> <span onmouseout="hideTip(event, 'fs14', 32)" onmouseover="showTip(event, 'fs14', 32)" class="i">EventCodec</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs14', 33)" onmouseover="showTip(event, 'fs14', 33)" class="i">EventCodec</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs2', 34)" onmouseover="showTip(event, 'fs2', 34)" class="i">Product</span><span class="o">&gt;</span> <span class="o">=</span> <span class="i">jsonValueCodec</span> <span class="s">&quot;</span><span class="s">product</span><span class="s">&quot;</span>

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs15', 35)" onmouseover="showTip(event, 'fs15', 35)" class="i">PriceCheckFailed</span> <span class="o">=</span> {
        <span onmouseout="hideTip(event, 'fs16', 36)" onmouseover="showTip(event, 'fs16', 36)" class="i">ProductId</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs6', 37)" onmouseover="showTip(event, 'fs6', 37)" class="i">int</span>
        <span onmouseout="hideTip(event, 'fs17', 38)" onmouseover="showTip(event, 'fs17', 38)" class="i">Message</span> <span class="o">:</span> <span onmouseout="hideTip(event, 'fs4', 39)" onmouseover="showTip(event, 'fs4', 39)" class="i">string</span>
    }</pre>
</td>
</tr>
</table>

<p>Once we have our types set up, we can start to construct the service itself. We tend to use a similar format for many of our services so that developers can get up to speed more quickly, as well as move across teams faster. Services have five main sections.</p>

<p>First, we set up our inputs and our outputs. Here, we are taking in the <code>Product</code> type that we just defined, and we need to return either a tuple of <code>Product</code> type and a <code>decimal</code> cost, or a <code>PriceCheckFailed</code> type, that will contain information about the reasons we can't currently check this price on the Nile site.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
<span class="l">6: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs21', 43)" onmouseover="showTip(event, 'fs21', 43)" class="i">Input</span> <span class="o">=</span> 
      | <span onmouseout="hideTip(event, 'fs22', 44)" onmouseover="showTip(event, 'fs22', 44)" class="i">Product</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs22', 45)" onmouseover="showTip(event, 'fs22', 45)" class="i">Product</span>

    <span class="k">type</span> <span onmouseout="hideTip(event, 'fs23', 46)" onmouseover="showTip(event, 'fs23', 46)" class="i">Output</span> <span class="o">=</span> 
      | <span onmouseout="hideTip(event, 'fs24', 47)" onmouseover="showTip(event, 'fs24', 47)" class="i">ProductPriceNile</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs22', 48)" onmouseover="showTip(event, 'fs22', 48)" class="i">Product</span> <span class="o">*</span> <span onmouseout="hideTip(event, 'fs25', 49)" onmouseover="showTip(event, 'fs25', 49)" class="i">decimal</span>
      | <span onmouseout="hideTip(event, 'fs26', 50)" onmouseover="showTip(event, 'fs26', 50)" class="i">ProductPriceCheckFailed</span> <span class="k">of</span> <span onmouseout="hideTip(event, 'fs15', 51)" onmouseover="showTip(event, 'fs15', 51)" class="i">PriceCheckFailed</span></pre>
</td>
</tr>
</table>

<p>Second, we define how to handle the input -- specifically, how to convert from the input to the output. In this case, I've cheated and constructed a tuple that fits the successful output type. However, this is the section of the microservice that would contain the longest bit of code, going out to the competing site and gathering the information, say through their API. Note that we're also using <code>Option</code> types, so that we have an additional check for failure. This will become important in our next step.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs27', 52)" onmouseover="showTip(event, 'fs27', 52)" class="i">handle</span> (<span onmouseout="hideTip(event, 'fs28', 53)" onmouseover="showTip(event, 'fs28', 53)" class="i">input</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs21', 54)" onmouseover="showTip(event, 'fs21', 54)" class="i">Input</span>) <span class="o">=</span>
        <span onmouseout="hideTip(event, 'fs29', 55)" onmouseover="showTip(event, 'fs29', 55)" class="i">async</span> {
            <span class="k">return</span> <span onmouseout="hideTip(event, 'fs30', 56)" onmouseover="showTip(event, 'fs30', 56)" class="i">Some</span>(
                <span onmouseout="hideTip(event, 'fs24', 57)" onmouseover="showTip(event, 'fs24', 57)" class="i">ProductPriceNile</span>(
                    {<span class="i">Sku</span><span class="o">=</span><span class="s">&quot;</span><span class="s">343434</span><span class="s">&quot;</span>; 
                     <span class="i">ProductId</span> <span class="o">=</span> <span class="n">17</span>; 
                     <span class="i">ProductDescription</span> <span class="o">=</span> <span class="s">&quot;</span><span class="s">My</span><span class="s"> </span><span class="s">amazing</span><span class="s"> </span><span class="s">product</span><span class="s">&quot;</span>; 
                     <span class="i">CostPer</span><span class="o">=</span><span class="n">1.96M</span>}, 
                    <span class="n">3.96M</span>))
        }</pre>
</td>
</tr>
</table>

<p>Third, it's necessary to define how to interpret the output once we have received it. Here, we pattern match on what we received from the <code>handle</code> function. If we receive a successful response, we write to Kafka or EventStore. If we receive a failed response, we might log that failure and try again. The final case takes into account an unanticipated failure where we get no reponse at all, so we might log that failure, then raise an alert to the teams involved. By using an option type here, we have a third check -- for an unknown and unanticipated failure -- that would not have otherwise been used.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs31', 58)" onmouseover="showTip(event, 'fs31', 58)" class="i">interpret</span> <span onmouseout="hideTip(event, 'fs32', 59)" onmouseover="showTip(event, 'fs32', 59)" class="i">id</span> <span onmouseout="hideTip(event, 'fs33', 60)" onmouseover="showTip(event, 'fs33', 60)" class="i">output</span> <span class="o">=</span>
        <span class="k">match</span> <span onmouseout="hideTip(event, 'fs33', 61)" onmouseover="showTip(event, 'fs33', 61)" class="i">output</span> <span class="k">with</span>
        | <span onmouseout="hideTip(event, 'fs30', 62)" onmouseover="showTip(event, 'fs30', 62)" class="i">Some</span> (<span onmouseout="hideTip(event, 'fs23', 63)" onmouseover="showTip(event, 'fs23', 63)" class="i">Output</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs24', 64)" onmouseover="showTip(event, 'fs24', 64)" class="i">ProductPriceNile</span> (<span onmouseout="hideTip(event, 'fs34', 65)" onmouseover="showTip(event, 'fs34', 65)" class="i">e</span>, <span onmouseout="hideTip(event, 'fs35', 66)" onmouseover="showTip(event, 'fs35', 66)" class="i">price</span>))  <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs29', 67)" onmouseover="showTip(event, 'fs29', 67)" class="i">async</span> {()} <span class="c">// write to event store, kafka, etc. </span>
        | <span onmouseout="hideTip(event, 'fs30', 68)" onmouseover="showTip(event, 'fs30', 68)" class="i">Some</span> (<span onmouseout="hideTip(event, 'fs23', 69)" onmouseover="showTip(event, 'fs23', 69)" class="i">Output</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs26', 70)" onmouseover="showTip(event, 'fs26', 70)" class="i">ProductPriceCheckFailed</span> <span onmouseout="hideTip(event, 'fs36', 71)" onmouseover="showTip(event, 'fs36', 71)" class="i">e</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs29', 72)" onmouseover="showTip(event, 'fs29', 72)" class="i">async</span> {()} <span class="c">// log specific failure and try again</span>
        | <span onmouseout="hideTip(event, 'fs37', 73)" onmouseover="showTip(event, 'fs37', 73)" class="i">None</span> <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs29', 74)" onmouseover="showTip(event, 'fs29', 74)" class="i">async</span> {()} <span class="c">// log failure and raise alert</span></pre>
</td>
</tr>
</table>

<p>Fourth, we gather these functions into a <code>consume</code> method. This calls another <code>consume</code> method in one of our shared libraries, passing in a decoded input, as well as our <code>handle</code> and <code>interpret</code> methods.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l">1: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs38', 75)" onmouseover="showTip(event, 'fs38', 75)" class="i">consume</span> <span class="o">=</span> <span class="i">EventStoreQueue</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs38', 76)" onmouseover="showTip(event, 'fs38', 76)" class="i">consume</span> (<span class="i">decodeT</span> <span onmouseout="hideTip(event, 'fs21', 77)" onmouseover="showTip(event, 'fs21', 77)" class="i">Input</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs39', 78)" onmouseover="showTip(event, 'fs39', 78)" class="i">Product</span>) <span onmouseout="hideTip(event, 'fs27', 79)" onmouseover="showTip(event, 'fs27', 79)" class="i">handle</span> <span onmouseout="hideTip(event, 'fs31', 80)" onmouseover="showTip(event, 'fs31', 80)" class="i">interpret</span></pre>
</td>
</tr>
</table>

<p>Finally, we can subscribe to a specific event stream, calling our <code>consume</code> function for each event we receive.</p>

<table class="pre"><tr><td class="lines"><pre class="fssnip">
<span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
</pre>
</td>
<td class="snippet"><pre class="fssnip">
    <span class="i">EventStoreQueue</span><span class="o">.</span><span class="i">subscribeBufferedWithCheckpointStream</span> 
        (<span class="i">EventStore</span><span class="o">.</span><span class="i">connHost</span> <span class="s">&quot;</span><span class="s">MyEventStoreConnection</span><span class="s">&quot;</span>) 
        <span class="s">&quot;</span><span class="s">$</span><span class="s">myeventstream</span><span class="s">&quot;</span> 
        <span class="k">true</span> 
        <span class="n">500</span> 
        <span class="n">100</span> 
        (<span onmouseout="hideTip(event, 'fs40', 81)" onmouseover="showTip(event, 'fs40', 81)" class="i">TimeSpan</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs41', 82)" onmouseover="showTip(event, 'fs41', 82)" class="i">FromSeconds</span> <span class="n">1.0</span>) 
        <span class="s">&quot;</span><span class="s">Check_price_on_Nile</span><span class="s">&quot;</span>
    <span class="o">|&gt;</span> <span class="i">AsyncSeq</span><span class="o">.</span><span class="i">concatSeq</span>
    <span class="o">|&gt;</span> <span class="i">AsyncSeq</span><span class="o">.</span><span class="i">iterAsyncParThrottled</span> <span class="n">200</span> <span onmouseout="hideTip(event, 'fs38', 83)" onmouseover="showTip(event, 'fs38', 83)" class="i">consume</span></pre>
</td>
</tr>
</table>

<h3>Conclusion</h3>

<p>I've set up an example to show off the style we use at Jet for our F# microservices code. We aim to keep our microservices set up in the same manner across projects so that folks are easily able to transfer teams, as well as to get up to speed when they first start at Jet. Hopefully the tools and techniques outlined here can help you and your company get started with microservices in F#.</p>

<div class="tip" id="fs1">namespace Microsoft.FSharp.Data</div>
<div class="tip" id="fs2">type Product =<br />&#160;&#160;{Sku: string;<br />&#160;&#160;&#160;ProductId: int;<br />&#160;&#160;&#160;ProductDescription: string;<br />&#160;&#160;&#160;CostPer: decimal;}<br />&#160;&#160;static member FromJson : Product -&gt; &#39;a<br />&#160;&#160;static member ToJson : x:Product -&gt; &#39;a<br />&#160;&#160;static member EventCodec : obj<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.Product</div>
<div class="tip" id="fs3">Product.Sku: string</div>
<div class="tip" id="fs4">Multiple items<br />val string : value:&#39;T -&gt; string<br /><br />Full name: Microsoft.FSharp.Core.Operators.string<br /><br />--------------------<br />type string = System.String<br /><br />Full name: Microsoft.FSharp.Core.string</div>
<div class="tip" id="fs5">Product.ProductId: int</div>
<div class="tip" id="fs6">Multiple items<br />val int : value:&#39;T -&gt; int (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.int<br /><br />--------------------<br />type int = int32<br /><br />Full name: Microsoft.FSharp.Core.int<br /><br />--------------------<br />type int&lt;&#39;Measure&gt; = int<br /><br />Full name: Microsoft.FSharp.Core.int&lt;_&gt;</div>
<div class="tip" id="fs7">Product.ProductDescription: string</div>
<div class="tip" id="fs8">Product.CostPer: decimal</div>
<div class="tip" id="fs9">Multiple items<br />val decimal : value:&#39;T -&gt; decimal (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.decimal<br /><br />--------------------<br />type decimal = System.Decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal<br /><br />--------------------<br />type decimal&lt;&#39;Measure&gt; = decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal&lt;_&gt;</div>
<div class="tip" id="fs10">static member Product.ToJson : x:Product -&gt; &#39;a<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.Product.ToJson</div>
<div class="tip" id="fs11">val x : Product</div>
<div class="tip" id="fs12">static member Product.FromJson : Product -&gt; &#39;a<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.Product.FromJson</div>
<div class="tip" id="fs13">val json : obj</div>
<div class="tip" id="fs14">static member Product.EventCodec : obj<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.Product.EventCodec</div>
<div class="tip" id="fs15">type PriceCheckFailed =<br />&#160;&#160;{ProductId: int;<br />&#160;&#160;&#160;Message: string;}<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.PriceCheckFailed</div>
<div class="tip" id="fs16">PriceCheckFailed.ProductId: int</div>
<div class="tip" id="fs17">PriceCheckFailed.Message: string</div>
<div class="tip" id="fs18">module service<br /><br />from 11-27-how-jet-build-microservices-with_</div>
<div class="tip" id="fs19">namespace System</div>
<div class="tip" id="fs20">module Types<br /><br />from 11-27-how-jet-build-microservices-with_</div>
<div class="tip" id="fs21">type Input = | Product of Product<br /><br />Full name: 11-27-how-jet-build-microservices-with_.service.Input</div>
<div class="tip" id="fs22">Multiple items<br />union case Input.Product: Product -&gt; Input<br /><br />--------------------<br />type Product =<br />&#160;&#160;{Sku: string;<br />&#160;&#160;&#160;ProductId: int;<br />&#160;&#160;&#160;ProductDescription: string;<br />&#160;&#160;&#160;CostPer: decimal;}<br />&#160;&#160;static member FromJson : Product -&gt; &#39;a<br />&#160;&#160;static member ToJson : x:Product -&gt; &#39;a<br />&#160;&#160;static member EventCodec : obj<br /><br />Full name: 11-27-how-jet-build-microservices-with_.Types.Product</div>
<div class="tip" id="fs23">type Output =<br />&#160;&#160;| ProductPriceNile of Product * decimal<br />&#160;&#160;| ProductPriceCheckFailed of PriceCheckFailed<br /><br />Full name: 11-27-how-jet-build-microservices-with_.service.Output</div>
<div class="tip" id="fs24">union case Output.ProductPriceNile: Product * decimal -&gt; Output</div>
<div class="tip" id="fs25">Multiple items<br />val decimal : value:&#39;T -&gt; decimal (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.decimal<br /><br />--------------------<br />type decimal = Decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal<br /><br />--------------------<br />type decimal&lt;&#39;Measure&gt; = decimal<br /><br />Full name: Microsoft.FSharp.Core.decimal&lt;_&gt;</div>
<div class="tip" id="fs26">union case Output.ProductPriceCheckFailed: PriceCheckFailed -&gt; Output</div>
<div class="tip" id="fs27">val handle : input:Input -&gt; Async&lt;Output option&gt;<br /><br />Full name: 11-27-how-jet-build-microservices-with_.service.handle</div>
<div class="tip" id="fs28">val input : Input</div>
<div class="tip" id="fs29">val async : AsyncBuilder<br /><br />Full name: Microsoft.FSharp.Core.ExtraTopLevelOperators.async</div>
<div class="tip" id="fs30">union case Option.Some: Value: &#39;T -&gt; Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs31">val interpret : id:&#39;a -&gt; output:Output option -&gt; Async&lt;unit&gt;<br /><br />Full name: 11-27-how-jet-build-microservices-with_.service.interpret</div>
<div class="tip" id="fs32">val id : &#39;a</div>
<div class="tip" id="fs33">val output : Output option</div>
<div class="tip" id="fs34">val e : Product</div>
<div class="tip" id="fs35">val price : decimal</div>
<div class="tip" id="fs36">val e : PriceCheckFailed</div>
<div class="tip" id="fs37">union case Option.None: Option&lt;&#39;T&gt;</div>
<div class="tip" id="fs38">val consume : obj<br /><br />Full name: 11-27-how-jet-build-microservices-with_.service.consume</div>
<div class="tip" id="fs39">union case Input.Product: Product -&gt; Input</div>
<div class="tip" id="fs40">Multiple items<br />type TimeSpan =<br />&#160;&#160;struct<br />&#160;&#160;&#160;&#160;new : ticks:int64 -&gt; TimeSpan + 3 overloads<br />&#160;&#160;&#160;&#160;member Add : ts:TimeSpan -&gt; TimeSpan<br />&#160;&#160;&#160;&#160;member CompareTo : value:obj -&gt; int + 1 overload<br />&#160;&#160;&#160;&#160;member Days : int<br />&#160;&#160;&#160;&#160;member Duration : unit -&gt; TimeSpan<br />&#160;&#160;&#160;&#160;member Equals : value:obj -&gt; bool + 1 overload<br />&#160;&#160;&#160;&#160;member GetHashCode : unit -&gt; int<br />&#160;&#160;&#160;&#160;member Hours : int<br />&#160;&#160;&#160;&#160;member Milliseconds : int<br />&#160;&#160;&#160;&#160;member Minutes : int<br />&#160;&#160;&#160;&#160;...<br />&#160;&#160;end<br /><br />Full name: System.TimeSpan<br /><br />--------------------<br />TimeSpan()<br />TimeSpan(ticks: int64) : unit<br />TimeSpan(hours: int, minutes: int, seconds: int) : unit<br />TimeSpan(days: int, hours: int, minutes: int, seconds: int) : unit<br />TimeSpan(days: int, hours: int, minutes: int, seconds: int, milliseconds: int) : unit</div>
<div class="tip" id="fs41">TimeSpan.FromSeconds(value: float) : TimeSpan</div>

</div>
<span class='st_reddit'></span>
<span class='st_facebook'></span>
<span class='st_twitter'></span>
<span class='st_linkedin'></span>
<span class='st_googleplus'></span>
<span class='st_tumblr'></span>
<span class='st_instapaper'></span>
<span class='st_email'></span>

    </section>
    <footer>
        <p><small>Hosted on Azure, using FsBlog. Because F# + Azure |> Jet <3.</small></p>
    </footer>
    <script src="http://tech.jet.com/javascripts/scale.fix.js"></script>
</body>
</html>
